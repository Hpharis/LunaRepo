---
import { getCollection, getEntryBySlug } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";

export const prerender = true;

// âœ… Collect all slugs for all collections
export async function getStaticPaths() {
  const collections = ["blog", "gear", "guides", "upgrades"];
  const paths = [];

  for (const c of collections) {
    const posts = await getCollection(c);
    for (const p of posts) {
      paths.push({ params: { collection: c, slug: p.slug } });
    }
  }

  return paths;
}

const { slug, collection } = Astro.params;
const post = await getEntryBySlug(collection, slug);
if (!post) throw new Error(`Post not found: ${collection}/${slug}`);

const placeholder = "/assets/blog-placeholder-1.jpg";
const data = post.data;
const { Content } = await post.render();

// âœ… JSON-LD for SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: data.title,
  datePublished: data.pubDate,
  dateModified: data.updatedDate || data.pubDate,
  author: {
    "@type": "Person",
    name: data.author || "TouringMag Editorial Team",
  },
  image: data.heroImage || placeholder,
  description: data.summary || "",
};
---

<BaseLayout
  title={`${data.title} â€“ TouringMag`}
  description={data.summary || ""}
  image={data.heroImage || placeholder}
>
  <!-- ðŸ“° Hero Banner -->
  <div class="relative mb-12">
    <img
      src={data.heroImage || placeholder}
      alt={data.title}
      class="w-full h-72 md:h-96 object-cover rounded-lg shadow-lg"
    />
    <div class="absolute inset-0 bg-black/50 rounded-lg flex flex-col items-center justify-center text-center px-6">
      <h1 class="text-3xl md:text-5xl font-extrabold text-white drop-shadow mb-2">
        {data.title}
      </h1>
      {data.summary && <p class="text-gray-200 max-w-2xl">{data.summary}</p>}
      <p class="text-sm text-gray-400 mt-4">
        {data.pubDate && <FormattedDate date={data.pubDate} />}
        {data.updatedDate && (
          <span class="ml-2 italic">
            (updated <FormattedDate date={data.updatedDate} />)
          </span>
        )}
      </p>
      {data.author && (
        <p class="text-sm text-gray-300 italic mt-1">
          {data.author} â€” {data.role}
        </p>
      )}
    </div>
  </div>

  <!-- ðŸ“° Two-Column Layout -->
  <div class="grid md:grid-cols-3 gap-8 max-w-7xl mx-auto">
    <!-- Main article -->
    <article class="prose prose-invert md:col-span-2 max-w-none">
      <Content />
    </article>

    <!-- Sidebar -->
    <aside class="space-y-6">
      <div class="bg-neutral-900 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-orange-500 mb-3">Related Reads</h3>
        <ul class="space-y-2 text-sm">
          <li><a href="/gear" class="hover:text-orange-400">Latest Gear Reviews</a></li>
          <li><a href="/upgrades" class="hover:text-orange-400">Upgrade Ideas</a></li>
          <li><a href="/guides" class="hover:text-orange-400">Touring Guides</a></li>
        </ul>
      </div>
      <div class="bg-neutral-900 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-orange-500 mb-3">Subscribe</h3>
        <form
          action="https://your-mailchimp-or-zoho-endpoint"
          method="POST"
          class="space-y-2"
        >
          <input
            type="email"
            name="EMAIL"
            placeholder="Enter your email"
            required
            class="w-full p-2 rounded bg-neutral-950 border border-neutral-700 text-white"
          />
          <button
            type="submit"
            class="w-full bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"
          >
            Subscribe
          </button>
        </form>
      </div>
    </aside>
  </div>

  <!-- âœ… JSON-LD Structured Data -->
  <script type="application/ld+json">
    {JSON.stringify(jsonLd)}
  </script>
</BaseLayout>
